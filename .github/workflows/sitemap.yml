name: Refresh Sitemap

on:
  schedule:
    - cron: '15 * * * *'  # Runs every hour at :15
  workflow_dispatch:

jobs:
  update-sitemap:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Generate sitemap.xml if missing
      run: |
        if [ ! -f sitemap.xml ]; then
          echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > sitemap.xml
          echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> sitemap.xml
          for PAGE in "" education jobs current-affairs results quizzes; do
            echo "<url><loc>https://sandeepswami7426-oss.github.io/latest-education-hub/${PAGE}.html</loc><lastmod>$(date +"%Y-%m-%dT%H:%M:%S+05:30")</lastmod><changefreq>hourly</changefreq><priority>0.8</priority></url>" >> sitemap.xml
          done
          echo "</urlset>" >> sitemap.xml
          echo "ğŸ†• Sitemap.xml created with default structure"
        fi

    - name: Update <lastmod> timestamps
      run: |
        NOW=$(date +"%Y-%m-%dT%H:%M:%S+05:30")
        sed -i "s|<lastmod>.*</lastmod>|<lastmod>$NOW</lastmod>|g" sitemap.xml
        echo "ğŸ—ºï¸ Sitemap updated with lastmod: $NOW"

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        git add sitemap.xml
        if git diff --cached --quiet; then
          echo "âœ… Sitemap already up to date. No commit needed."
        else
          git commit -m "ğŸ—ºï¸ Sitemap refreshed: $NOW"
          git push origin main
          echo "ğŸ‰ Sitemap pushed successfully!"