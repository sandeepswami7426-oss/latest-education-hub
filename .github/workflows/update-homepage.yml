name: Update Homepage with All Sections

on:
  schedule:
    - cron: '5 * * * *'  # рд╣рд░ рдШрдВрдЯреЗ 5 рдорд┐рдирдЯ рдкрд░ рдЪрд▓реЗрдЧрд╛
  workflow_dispatch:

jobs:
  update-homepage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch RSS feeds
      run: |
        curl -s https://www.jagranjosh.com/rss/education.xml -o education.xml
        curl -s https://www.jagranjosh.com/rss/jobs.xml -o jobs.xml
        curl -s https://www.hindustantimes.com/feeds/rss/india-news/rssfeed.xml -o current.xml

    - name: Clean old injected blocks
      run: |
        sed -i '/<!--EDUCATION_PLACEHOLDER-->/,/<!--JOBS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

        sed -i '/<!--JOBS_PLACEHOLDER-->/,/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

        sed -i '/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/,/<!--RESULTS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

        sed -i '/<!--RESULTS_PLACEHOLDER-->/,/<!--QUIZZES_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

    - name: Inject content into index.html
      run: |
        # ЁЯФН Education
        EDU_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' education.xml | sed -n '3,$p')
        if [ -z "$EDU_HEADLINES" ]; then
          sed -i "/<!--EDUCATION_PLACEHOLDER-->/a <details><summary>тЪая╕П рдХреЛрдИ рдПрдЬреБрдХреЗрд╢рди рдЦрдмрд░ рдирд╣реАрдВ рдорд┐рд▓реА</summary><p>RSS feed рдЦрд╛рд▓реА рд╣реИ рдпрд╛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рд╣реБрдЖред</p></details>" index.html
        else
          for HEADLINE in $EDU_HEADLINES; do
            BLOCK="<details><summary>$HEADLINE</summary><p>рдпрд╣ рдЦрдмрд░ JagranJosh рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='education.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
            sed -i "/<!--EDUCATION_PLACEHOLDER-->/a $BLOCK" index.html
          done
        fi

        # ЁЯФН Jobs
        JOB_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' jobs.xml | sed -n '3,$p')
        if [ -z "$JOB_HEADLINES" ]; then
          sed -i "/<!--JOBS_PLACEHOLDER-->/a <details><summary>тЪая╕П рдХреЛрдИ рдЬреЙрдм рдЦрдмрд░ рдирд╣реАрдВ рдорд┐рд▓реА</summary><p>RSS feed рдЦрд╛рд▓реА рд╣реИ рдпрд╛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рд╣реБрдЖред</p></details>" index.html
        else
          for HEADLINE in $JOB_HEADLINES; do
            BLOCK="<details><summary>$HEADLINE</summary><p>рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА JagranJosh рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='jobs.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
            sed -i "/<!--JOBS_PLACEHOLDER-->/a $BLOCK" index.html
          done
        fi

        # ЁЯФН Current Affairs
        CUR_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' current.xml | sed -n '3,$p')
        if [ -z "$CUR_HEADLINES" ]; then
          sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/a <details><summary>тЪая╕П рдХреЛрдИ рдХрд░реЗрдВрдЯ рдЕрдлреЗрдпрд░реНрд╕ рдЦрдмрд░ рдирд╣реАрдВ рдорд┐рд▓реА</summary><p>RSS feed рдЦрд╛рд▓реА рд╣реИ рдпрд╛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рд╣реБрдЖред</p></details>" index.html
        else
          for HEADLINE in $CUR_HEADLINES; do
            BLOCK="<details><summary>$HEADLINE</summary><p>рдпрд╣ рдЦрдмрд░ Hindustan Times рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='current-affairs.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
            sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/a $BLOCK" index.html
          done
        fi

        # ЁЯУК Results Section (Static block)
        RESULTS_BLOCK="<details><summary>ЁЯУв рдЕрднреА рдХреЗ рд░рд┐рдЬрд▓реНрдЯреНрд╕</summary><p>UPSC, SSC, рдФрд░ рдЕрдиреНрдп рдкрд░реАрдХреНрд╖рд╛рдУрдВ рдХреЗ рд░рд┐рдЬрд▓реНрдЯреНрд╕ рдЬрд▓реНрдж рдЕрдкрдбреЗрдЯ рд╣реЛрдВрдЧреЗред</p><a href='results.html'>рдкреВрд░рд╛ рджреЗрдЦреЗрдВ</a></details>"
        sed -i "/<!--RESULTS_PLACEHOLDER-->/a $RESULTS_BLOCK" index.html

        # ЁЯза Quizzes Section (Static block)
        QUIZ_BLOCK="<details><summary>ЁЯза рдЖрдЬ рдХрд╛ рдХреНрд╡рд┐рдЬрд╝: рдХрд░реЗрдВрдЯ рдЕрдлреЗрдпрд░реНрд╕</summary><p>5 рд╕рд╡рд╛рд▓, 5 рдорд┐рдирдЯ рдореЗрдВ тАФ рдЕрдкрдиреА рддреИрдпрд╛рд░реА рдЬрд╛рдВрдЪреЗрдВ!</p><a href='quizzes.html'>рдЕрднреА рдЦреЗрд▓реЗрдВ</a></details>"
        sed -i "/<!--QUIZZES_PLACEHOLDER-->/a $QUIZ_BLOCK" index.html

        # ЁЯФД Timestamp Update
        DATE=$(date +"%d %B %Y, %I:%M %p")
        sed -i "s|ЁЯФД рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ:.*|ЁЯФД рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ: $DATE|" index.html

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        echo "ЁЯУМ Staging all modified files..."
        git add index.html

        if git diff --cached --quiet; then
          echo "тЬЕ Homepage already up to date. No commit needed."
        else
          COMMIT_MSG="ЁЯдЦ Homepage Updated: $DATE"
          echo "тЬЕ Committing with message: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          git push origin main
          echo "ЁЯОЙ Push successful!"