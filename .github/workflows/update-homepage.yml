name: Update Homepage with All Sections

on:
  schedule:
    - cron: '5 * * * *'  # Runs every hour at :05
  workflow_dispatch:

jobs:
  update-homepage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch RSS feeds
      run: |
        curl -s https://www.jagranjosh.com/rss/education.xml -o education.xml
        curl -s https://www.jagranjosh.com/rss/jobs.xml -o jobs.xml
        curl -s https://www.hindustantimes.com/feeds/rss/india-news/rssfeed.xml -o current.xml

    - name: Clean old injected blocks
      run: |
        for TAG in EDUCATION JOBS CURRENT_AFFAIRS RESULTS QUIZZES; do
          sed -i "/<!--${TAG}_PLACEHOLDER-->/,/<!--/{
            /<details>/,/<\/details>/d
          }" index.html
        done

    - name: Inject content into index.html
      run: |
        # üîç Education
        EDU_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' education.xml | sed -n '3p')
        if [ -z "$EDU_HEADLINES" ]; then
          BLOCK="<details><summary>‚ö†Ô∏è No education news found</summary><p>RSS feed is empty or unavailable.</p></details>"
        else
          BLOCK="<details><summary>$EDU_HEADLINES</summary><p>Source: JagranJosh</p><a href='education.html'>View More</a></p></details>"
        fi
        sed -i "/<!--EDUCATION_PLACEHOLDER-->/a $BLOCK" index.html

        # üîç Jobs
        JOB_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' jobs.xml | sed -n '3p')
        if [ -z "$JOB_HEADLINES" ]; then
          BLOCK="<details><summary>‚ö†Ô∏è No job news found</summary><p>RSS feed is empty or unavailable.</p></details>"
        else
          BLOCK="<details><summary>$JOB_HEADLINES</summary><p>Source: JagranJosh</p><a href='jobs.html'>View More</a></p></details>"
        fi
        sed -i "/<!--JOBS_PLACEHOLDER-->/a $BLOCK" index.html

        # üîç Current Affairs
        CUR_HEADLINES=$(grep -oP '(?<=<title>).*?(?=</title>)' current.xml | sed -n '3p')
        if [ -z "$CUR_HEADLINES" ]; then
          BLOCK="<details><summary>‚ö†Ô∏è No current affairs found</summary><p>RSS feed is empty or unavailable.</p></details>"
        else
          BLOCK="<details><summary>$CUR_HEADLINES</summary><p>Source: Hindustan Times</p><a href='current-affairs.html'>View More</a></p></details>"
        fi
        sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/a $BLOCK" index.html

        # üìä Results Section (Static block)
        RESULTS_BLOCK="<details><summary>üì¢ Latest Results</summary><p>UPSC, SSC, and other exam results will be updated soon.</p><a href='results.html'>View All</a></details>"
        sed -i "/<!--RESULTS_PLACEHOLDER-->/a $RESULTS_BLOCK" index.html

        # üß† Quizzes Section (Static block)
        QUIZ_BLOCK="<details><summary>üß† Today‚Äôs Quiz: Current Affairs</summary><p>5 questions in 5 minutes ‚Äî test your preparation!</p><a href='quizzes.html'>Play Now</a></details>"
        sed -i "/<!--QUIZZES_PLACEHOLDER-->/a $QUIZ_BLOCK" index.html

        # üîÑ Timestamp Update
        DATE=$(date +"%d %B %Y, %I:%M %p")
        sed -i "s|üîÑ Last Updated:.*|üîÑ Last Updated: $DATE|" index.html
        echo "‚úÖ Homepage updated at: $DATE"

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        git add index.html
        if git diff --cached --quiet; then
          echo "‚úÖ Homepage already up to date. No commit needed."
        else
          COMMIT_MSG="ü§ñ Homepage Updated: $DATE"
          git commit -m "$COMMIT_MSG"
          git push origin main
          echo "üéâ Push successful!"