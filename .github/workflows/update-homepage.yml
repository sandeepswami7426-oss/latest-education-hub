name: Update Homepage with All Sections

on:
  schedule:
    - cron: '5 * * * *'  # рд╣рд░ рдШрдВрдЯреЗ 5 рдорд┐рдирдЯ рдкрд░ рдЪрд▓реЗрдЧрд╛
  workflow_dispatch:

jobs:
  update-homepage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch RSS feeds
      run: |
        curl -s https://www.jagranjosh.com/rss/education.xml -o education.xml
        curl -s https://www.jagranjosh.com/rss/jobs.xml -o jobs.xml
        curl -s https://www.hindustantimes.com/feeds/rss/india-news/rssfeed.xml -o current.xml

    - name: Extract headlines with fallback
      run: |
        EDU=$(grep -oP '(?<=<title>).*?(?=</title>)' education.xml | sed -n '3p')
        JOB=$(grep -oP '(?<=<title>).*?(?=</title>)' jobs.xml | sed -n '3p')
        CUR=$(grep -oP '(?<=<title>).*?(?=</title>)' current.xml | sed -n '3p')

        [ -z "$EDU" ] && EDU="тЪая╕П рдХреЛрдИ рдПрдЬреБрдХреЗрд╢рди рд╣реЗрдбрд▓рд╛рдЗрди рдирд╣реАрдВ рдорд┐рд▓реА"
        [ -z "$JOB" ] && JOB="тЪая╕П рдХреЛрдИ рдЬреЙрдм рд╣реЗрдбрд▓рд╛рдЗрди рдирд╣реАрдВ рдорд┐рд▓реА"
        [ -z "$CUR" ] && CUR="тЪая╕П рдХреЛрдИ рдХрд░реЗрдВрдЯ рдЕрдлреЗрдпрд░реНрд╕ рд╣реЗрдбрд▓рд╛рдЗрди рдирд╣реАрдВ рдорд┐рд▓реА"

        echo "ЁЯУЪ Education: $EDU"
        echo "ЁЯТ╝ Jobs: $JOB"
        echo "ЁЯУ░ Current Affairs: $CUR"

    - name: Clean old injected blocks
      run: |
        sed -i '/<!--EDUCATION_PLACEHOLDER-->/,/<!--JOBS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

        sed -i '/<!--JOBS_PLACEHOLDER-->/,/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

        sed -i '/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/,/<!--RESULTS_PLACEHOLDER-->/{
          /<details>/,/<\/details>/d
        }' index.html

    - name: Inject content into index.html
      run: |
        EDU_BLOCK="<details><summary>$EDU</summary><p>рдпрд╣ рдЦрдмрд░ JagranJosh рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='education.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
        sed -i "/<!--EDUCATION_PLACEHOLDER-->/a $EDU_BLOCK" index.html

        JOB_BLOCK="<details><summary>$JOB</summary><p>рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА JagranJosh рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='jobs.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
        sed -i "/<!--JOBS_PLACEHOLDER-->/a $JOB_BLOCK" index.html

        CUR_BLOCK="<details><summary>$CUR</summary><p>рдпрд╣ рдЦрдмрд░ Hindustan Times рд╕реЗ рд▓реА рдЧрдИ рд╣реИред</p><a href='current-affairs.html'>рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдкрдврд╝реЗрдВ...</a></details>"
        sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/a $CUR_BLOCK" index.html

        DATE=$(date +"%d %B %Y, %I:%M %p")
        sed -i "s|ЁЯФД рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ:.*|ЁЯФД рдЕрдВрддрд┐рдо рдЕрдкрдбреЗрдЯ: $DATE|" index.html

    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        echo "ЁЯУМ Staging all modified files..."
        git add index.html

        if git diff --cached --quiet; then
          echo "тЬЕ Homepage already up to date. No commit needed."
        else
          COMMIT_MSG="ЁЯдЦ Homepage Updated: $EDU | $JOB | $CUR"
          echo "тЬЕ Committing with message: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          git push origin main
          echo "ЁЯОЙ Push successful!"
        fi