name: Auto Update All Sections

on:
  schedule:
    - cron: '5 * * * *'  # ‡§π‡§∞ ‡§ò‡§Ç‡§ü‡•á 5 ‡§Æ‡§ø‡§®‡§ü ‡§™‡§∞ auto-run
  workflow_dispatch:

jobs:
  update-site:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch RSS feeds with fallback
      run: |
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/rssfeed.xml -o education.xml || echo "<rss><channel><title>Error</title></channel></rss>" > education.xml
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/employment-news/rssfeed.xml -o jobs.xml || echo "<rss><channel><title>Error</title></channel></rss>" > jobs.xml
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/competitive-exams/rssfeed.xml -o current.xml || echo "<rss><channel><title>Error</title></channel></rss>" > current.xml

    - name: Clean old blocks
      run: |
        for FILE in index.html education.html jobs.html current-affairs.html results.html quizzes.html; do
          sed -i '/<details>/,/<\/details>/d' "$FILE"
        done

    - name: Inject headlines into all pages
      run: |
        # Education
        EDU=$(grep -oP '(?<=<title>).*?(?=</title>)' education.xml | sed -n '3p')
        [ -z "$EDU" ] && EDU="‚ö†Ô∏è No education headline found"
        echo "<details><summary>$EDU</summary><p>Source: HT Education</p><a href='education.html'>View More</a></p></details>" > temp-edu.html
        sed -i "/<!--EDUCATION_PLACEHOLDER-->/r temp-edu.html" index.html
        sed -i "/<!--EDUPAGEPLACEHOLDER-->/r temp-edu.html" education.html
        rm temp-edu.html

        # Jobs
        JOB=$(grep -oP '(?<=<title>).*?(?=</title>)' jobs.xml | sed -n '3p')
        [ -z "$JOB" ] && JOB="‚ö†Ô∏è No job headline found"
        echo "<details><summary>$JOB</summary><p>Source: HT Employment News</p><a href='jobs.html'>View More</a></p></details>" > temp-job.html
        sed -i "/<!--JOBS_PLACEHOLDER-->/r temp-job.html" index.html
        sed -i "/<!--JOBSPAGEPLACEHOLDER-->/r temp-job.html" jobs.html
        rm temp-job.html

        # Current Affairs
        CUR=$(grep -oP '(?<=<title>).*?(?=</title>)' current.xml | sed -n '3p')
        [ -z "$CUR" ] && CUR="‚ö†Ô∏è No current affairs found"
        echo "<details><summary>$CUR</summary><p>Source: HT Competitive Exams</p><a href='current-affairs.html'>View More</a></p></details>" > temp-cur.html
        sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/r temp-cur.html" index.html
        sed -i "/<!--CURPAGEPLACEHOLDER-->/r temp-cur.html" current-affairs.html
        rm temp-cur.html

        # Static Results block
        echo "<details><summary>üì¢ Latest Results</summary><p>UPSC, SSC, and other exam results will be updated soon.</p><a href='results.html'>View All</a></details>" > temp-results.html
        sed -i "/<!--RESULTS_PLACEHOLDER-->/r temp-results.html" index.html
        sed -i "/<!--RESULTSPAGEPLACEHOLDER-->/r temp-results.html" results.html
        rm temp-results.html

        # Static Quiz block
        echo "<details><summary>üß† Today‚Äôs Quiz: Current Affairs</summary><p>5 questions in 5 minutes ‚Äî test your preparation!</p><a href='quizzes.html'>Play Now</a></details>" > temp-quiz.html
        sed -i "/<!--QUIZZES_PLACEHOLDER-->/r temp-quiz.html" index.html
        sed -i "/<!--QUIZZESPAGEPLACEHOLDER-->/r temp-quiz.html" quizzes.html
        rm temp-quiz.html

        # Timestamp
        DATE=$(date +"%d %B %Y, %I:%M %p")
        sed -i "s|üîÑ Last Updated:.*|üîÑ Last Updated: $DATE|" index.html

    - name: Commit and push
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit --allow-empty -m "üîÑ Auto-updated all sections: $DATE"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        git push origin main
        echo "üéâ Push successful!"