name: Auto Update Homepage

on:
  schedule:
    - cron: '5 * * * *'  # à¤¹à¤° à¤˜à¤‚à¤Ÿà¥‡ 5 à¤®à¤¿à¤¨à¤Ÿ à¤ªà¤° auto-run
  workflow_dispatch:

jobs:
  update-homepage:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Fetch RSS feeds
      run: |
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/rssfeed.xml -o education.xml || echo "<rss><channel><title>Error</title></channel></rss>" > education.xml
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/employment-news/rssfeed.xml -o jobs.xml || echo "<rss><channel><title>Error</title></channel></rss>" > jobs.xml
        curl -s --fail https://www.hindustantimes.com/feeds/rss/education/competitive-exams/rssfeed.xml -o current.xml || echo "<rss><channel><title>Error</title></channel></rss>" > current.xml

    - name: Clean old homepage blocks
      run: |
        sed -i '/<details>/,/<\/details>/d' index.html

    - name: Inject homepage blocks
      run: |
        export LANG=en_US.UTF-8
        export LC_ALL=en_US.UTF-8

        EDU=$(grep -oP '(?<=<title>).*?(?=</title>)' education.xml | sed -n '3p')
        [ -z "$EDU" ] && EDU="âš ï¸ No education headline found"
        echo "<details><summary>$EDU</summary><p>Source: HT Education</p><a href='education.html'>View More</a></p></details>" > temp-edu.html
        grep -q "<!--EDUCATION_PLACEHOLDER-->" index.html && sed -i "/<!--EDUCATION_PLACEHOLDER-->/r temp-edu.html" index.html
        rm temp-edu.html
        echo "ğŸ§ª Injected EDU: $EDU"

        JOB=$(grep -oP '(?<=<title>).*?(?=</title>)' jobs.xml | sed -n '3p')
        [ -z "$JOB" ] && JOB="âš ï¸ No job headline found"
        echo "<details><summary>$JOB</summary><p>Source: HT Employment News</p><a href='jobs.html'>View More</a></p></details>" > temp-job.html
        grep -q "<!--JOBS_PLACEHOLDER-->" index.html && sed -i "/<!--JOBS_PLACEHOLDER-->/r temp-job.html" index.html
        rm temp-job.html
        echo "ğŸ§ª Injected JOB: $JOB"

        CUR=$(grep -oP '(?<=<title>).*?(?=</title>)' current.xml | sed -n '3p')
        [ -z "$CUR" ] && CUR="âš ï¸ No current affairs found"
        echo "<details><summary>$CUR</summary><p>Source: HT Competitive Exams</p><a href='current-affairs.html'>View More</a></p></details>" > temp-cur.html
        grep -q "<!--CURRENT_AFFAIRS_PLACEHOLDER-->" index.html && sed -i "/<!--CURRENT_AFFAIRS_PLACEHOLDER-->/r temp-cur.html" index.html
        rm temp-cur.html
        echo "ğŸ§ª Injected CUR: $CUR"

        echo "<details><summary>ğŸ“¢ Latest Results</summary><p>UPSC, SSC, and other exam results will be updated soon.</p><a href='results.html'>View All</a></details>" > temp-results.html
        grep -q "<!--RESULTS_PLACEHOLDER-->" index.html && sed -i "/<!--RESULTS_PLACEHOLDER-->/r temp-results.html" index.html
        rm temp-results.html

        echo "<details><summary>ğŸ§  Todayâ€™s Quiz: Current Affairs</summary><p>5 questions in 5 minutes â€” test your preparation!</p><a href='quizzes.html'>Play Now</a></details>" > temp-quiz.html
        grep -q "<!--QUIZZES_PLACEHOLDER-->" index.html && sed -i "/<!--QUIZZES_PLACEHOLDER-->/r temp-quiz.html" index.html
        rm temp-quiz.html

        DATE=$(date +"%d %B %Y, %I:%M %p")
        sed -i "s|ğŸ”„ Last Updated:.*|ğŸ”„ Last Updated: $DATE|" index.html
        echo "ğŸ•’ Updated timestamp: $DATE"

    - name: Commit and push
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add index.html
        git commit --allow-empty -m "ğŸ”„ Auto-updated homepage: $DATE"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        git push origin main
        echo "ğŸš€ Push successful!"